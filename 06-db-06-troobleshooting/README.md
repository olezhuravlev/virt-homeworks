# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести данную операцию:
- напишите список операций, которые вы будете производить для остановки запроса пользователя
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB

===

**Ответ:**


Для снятия запроса с исполнения получим идентификатор операции с помощью метода `aggregate`:

````
use admin
db.aggregate([
   { $currentOp : { allUsers: true, localOps: true } },
   { $match : <УсловиеПоиска> }
])
````
где `<УсловиеПоиска>` - это условия, по которым следует искать операцию, например `{op: "getmore", "command.collection": "someCollection"}`.

> Также, в качестве альтернативы для поиска операции можно использовать метод `db.currentOp()`, возвращающий информацию о выполняемых в данный момент операциях.

После того, как идентификатор операции найден, снимаем запрос с помощью вызова метода `db.killOp`:

````
db.killOp(<ИдентификаторОперации>)
````

Для выясненения причин медленного выполнения запроса м.б. предпринято следующее:

| Возможная причина долгого выполнения запроса                    | Возможное решение                                                                                                                                            |
|-----------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Проблемы у клиента (например, сбой клиентской программы или ОС) | Проанализировать проблему и высвободить ресурсы клиента. Перезапуск клиента.                                                                                 |
| Проблемы с сетевым доступом к серверу                           | Проверить сетевое соединение и устранить конкретную проблему.                                                                                                |
| Проблемы на сервере (например, нет или мало свободной RAM)      | Проанализировать проблему и высвободить ресурсы сервера штатными средствами.                                                                                 |
| Проблемы с СУБД (сбой)                                          | Изучить логи и, возможно, перезапустить СУБД.                                                                                                                |
| Слишком сложный или неоптимальный запрос                        | Произвести анализ плана выполнения запроса с помощью метода `db.explain(<Параметры>)`<br/> и оптимизировать запрос для более эффективного извлечения данных. |
| Большой объем извлекаемых данных                                | Оптимизировать запрос разбиением на подзапросы (paging).                                                                                                     |


---

## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:
- сначала рост отношения записанных значений к истекшим
- Redis блокирует операции записи

Как вы думаете, в чем может быть проблема?

===

**Ответ:**

Механизм активной экспирации ключей в Redis устроен таким образом, что процедура удаления устаревших ключей запускается
10 раз в секунду и проверяет на валидность количество ключей, заданное параметром `ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP`.
Если среди этих ключей обнаруживается более 25% устаревших, то они удаляются, а процедура повторяется снова.
Запись в Redis новых ключей на это время блокируется. Такой механизм решает проблему забивания памяти устаревшими ключами.

Соответственно, в случае интенсивной записи в БД может получиться так, что существует большое количество одновременно (в одну и ту же секунду)
устаревающих ключей и тогда Redis заблокирует запись новых ключей, чтобы удалить старые. Запись будет разблокирована, когда
количество устаревших ключей станет меньше 25%.

Обычно такой подход работает нормально, потому что маловероятно, что в БД окажется большое количество одновременно устаревших ключей.
Но проблему может спровоцировать сам пользователь, если активно применяет механизм экспирации (`EXPIREAT`).

В нашем случае проблема скорее всего возникла из-за того, что **количество записанных ключей с одновременно закончившимся
сроком действия слишком велико и Redis перестал успевать их удалять**. Поэтому он заблокировал добавление новых ключей
до момента, когда их доля не станет меньше 25% от всех ключей проверяемого набора.

Рекомендуется либо **менее интенсивно использовать механизм Time-To-Live** либо **нарастить ресурсы сервера**.

---

## Задача 3

Перед выполнением задания познакомьтесь с документацией по [Common Mysql errors](https://dev.mysql.com/doc/refman/8.0/en/common-errors.html).

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения данной проблемы вы можете предложить?

===

**Ответ:**

В соответствии с документацией такая ошибка возникает в трех случаях и м.б. предложены следующие пути её решения:

| Возможная причина ошибки `Lost connection to MySQL server during query u'SELECT...'`                                             | Возможное решение                                                                                                                                                                                                                                          |
|----------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Проблемы с сетевым соединением                                                                                                   | Проверить сетевое соединение и, если пропускной способности недостаточно, увеличить её.                                                                                                                                                                    |
| Большой объём возвращаемых запросом данных, что приводит ко времени ожидания большем, чем указано в параметре `net_read_timout`. | Проанализировать запрос, включив перед его выполнением параметр `EXPLAIN ANALYZE`.<br/>По результатам анализа следует либо:<br/>- оптимизировать запрос;<br/>- нарастить производительность сервера;<br/>- увеличить значение параметра `net_read_timout`. |
| Первоначальное соединение с БД требует больше времени, чем указано в параметре `connect_timeout`.                                | Увеличить значение параметра `connect_timeout`.                                                                                                                                                                                                            |

---

## Задача 4

Перед выполнением задания ознакомтесь со статьей [Common PostgreSQL errors](https://www.percona.com/blog/2020/06/05/10-common-postgresql-errors/) из блога Percona.

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили данную проблему?

===

**Ответ:**

Критический недостаток памяти - `Out Of Memory (OOM)` - приводит к тому, что ядро **Linux**, желая сохранить
работоспособность ОС, запускает специальный процесс освобождения памяти, называемый  `OOM-Killer`.
Т.к. процесс PostgreSQL, скорее всего, аллоцирует большой объем памяти, то он и будет принудительно завершён что,
соответственно, приводит к недоступности БД.

Здесь рецепт один - нужно **нарастить количество памяти**, доступной для использования серверу, на котором работает СУБД.

---